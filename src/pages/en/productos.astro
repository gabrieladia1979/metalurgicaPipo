---
// src/pages/en/productos.astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import ProductCard from '../../components/ProductCard.astro';
import IndustrialPartCard from '../../components/IndustrialPartCard.astro';
import ProductTable from '../../components/ProductTable.astro';
import Footer from '../../components/Footer.astro';
import site from '../../data/site.json';

// Sample data - replace with CMS or database
const productos = [
  {
    id: 1,
    partNumber: 'AP-001',
    title: 'Piston Rings',
    category: 'Rings',
    description: 'Compression and guide rings to ensure efficient sealing and prolong life.',
    image: '/docs/producto 1.jpg',
    inStock: true,
    pdf: '', 
    specs: { 'Material': 'Cast Iron/Bronze/PTFE', 'Type': 'Compression/Guide' }
  },
  {
    id: 2,
    partNumber: 'VAL-002',
    title: 'Valves',
    category: 'Valves',
    description: 'High efficiency intake, exhaust, and concentric valves.',
    image: '/docs/producto 2.jpg',
    inStock: true,
    pdf: '',
    specs: { 'Material': 'Steel / Stainless', 'Pressure': 'High/Low' }
  },
  {
      id: 3,
      partNumber: 'PD-003',
      title: 'Unloader Piston',
      category: 'Pistons',
      description: 'Components for regulation and load control systems.',
      image: '/docs/producto 3.jpeg',
      inStock: true,
      pdf: '',
      specs: { 'Application': 'Load Control' }
  },
  {
      id: 4,
      partNumber: 'JUN-004',
      title: 'Gaskets',
      category: 'Gaskets',
      description: 'Gaskets for static sealing on covers, cylinders, and crankcases.',
      image: '/docs/producto 4.jpeg',
      inStock: true,
      pdf: '',
      specs: { 'Types': 'Covers, Cylinders' }
  },
  {
      id: 5,
      partNumber: 'SV-005',
      title: 'Rod Seals',
      category: 'Seals',
      description: 'Packing and dynamic seals for rods.',
      image: '/docs/producto 5.jpeg',
      inStock: true,
      pdf: '',
      specs: { 'Function': 'Dynamic Sealing' }
  },
  {
      id: 6,
      partNumber: 'RI-006',
      title: 'Internal Spare Parts',
      category: 'Spare Parts',
      description: 'Bearings, pins, bushings, and other internal components.',
      image: '/docs/producto 6.jpeg',
      inStock: true,
      pdf: '',
      specs: { 'Components': 'Various' }
  }
];
---

<Layout title="Products">
  <Header />

  <main class="min-h-screen bg-white">
    {/* Header */}
    <div class="bg-gradient-to-b from-gray-50 to-white py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          Product Catalog
        </h1>
        <p class="text-lg text-gray-600">
          Explore our wide selection of professional gastronomic equipment
        </p>
      </div>
    </div>

    {/* Products Grid */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:gap-4">
          <input id="page-search-input" type="search" placeholder="Filter by code, name or category" class="w-full md:w-1/2 border border-gray-300 rounded-lg py-2 px-3 text-sm" />
          <div class="mt-3 md:mt-0 flex gap-2">
            <button id="view-grid" type="button" class="px-3 py-2 bg-white border border-gray-300 rounded text-sm">Grid View</button>
            <button id="view-table" type="button" class="px-3 py-2 bg-white border border-gray-300 rounded text-sm">Table View</button>
          </div>
        </div>
        <p id="search-results" class="text-sm text-gray-600 mt-2"></p>
      </div>

      <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {productos.map((producto) => (
          <IndustrialPartCard
            partNumber={producto.partNumber}
            name={producto.title}
            specs={producto.specs}
            image={producto.image}
            inStock={producto.inStock}
            pdf={producto.pdf}
          />
        ))}
      </div>

      <div id="products-table" class="hidden mt-8">
        <ProductTable products={productos} />
      </div>
    </div>

    {/* CTA Final */}
    <section class="bg-bergner-red text-white py-16 mt-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Didn't find what you're looking for?</h2>
        <p class="text-lg mb-8 opacity-90">
          Contact us to inquire about other products or place a custom order.
        </p>
        <a 
          href={`https://wa.me/${site.whatsappNumber}?text=${encodeURIComponent('Hello, I have a question about Bergner products...')}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-block bg-white text-bergner-red hover:bg-gray-100 px-8 py-4 rounded-lg font-bold transition-colors"
        >
          Contact via WhatsApp
        </a>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  (function(){
    const params = new URLSearchParams(location.search);
    const q = (params.get('q')||'').toLowerCase().trim();
    const grid = document.getElementById('products-grid');
    const items = grid?.querySelectorAll('[data-title]');
    const headerInput = document.getElementById('header-search-input');
    const pageInput = document.getElementById('page-search-input');
    const resultsEl = document.getElementById('search-results');

    if(headerInput && q) headerInput.value = params.get('q');
    if(pageInput && q) pageInput.value = params.get('q');

    function filter(term){
      const t = (term||'').toLowerCase().trim();
      let any=false;
      items?.forEach(el=>{
        const title = (el.dataset.title||'').toLowerCase();
        const cat = (el.dataset.category||'').toLowerCase();
        const desc = (el.dataset.description||'').toLowerCase();
        const show = !t || title.includes(t) || cat.includes(t) || desc.includes(t);
        el.style.display = show ? '' : 'none';
        if(show) any = true;
      });
      if(resultsEl){
        resultsEl.textContent = t ? (any ? `Results for "${t}"` : `No results found for "${t}"`) : '';
      }
    }

    // initial
    filter(q);

    // listen for input on page
    if(pageInput){
      pageInput.addEventListener('input', (e)=>{
        const val = e.target.value;
        history.replaceState(null, '', val ? `?q=${encodeURIComponent(val)}` : location.pathname);
        if(headerInput) headerInput.value = val;
        filter(val);
      });
    }

    // View toggle (grid / table)
    const btnGrid = document.getElementById('view-grid');
    const btnTable = document.getElementById('view-table');
    const gridEl = document.getElementById('products-grid');
    const tableEl = document.getElementById('products-table');

    function setView(view){
      if(view==='table'){
        gridEl.classList.add('hidden');
        tableEl.classList.remove('hidden');
        history.replaceState(null,'',`?view=table${pageInput?.value?`&q=${encodeURIComponent(pageInput.value)}`:''}`);
      } else {
        tableEl.classList.add('hidden');
        gridEl.classList.remove('hidden');
        history.replaceState(null,'',`${location.pathname}${pageInput?.value?`?q=${encodeURIComponent(pageInput.value)}`:''}`);
      }
    }

    btnGrid?.addEventListener('click', ()=> setView('grid'));
    btnTable?.addEventListener('click', ()=> setView('table'));

    // initialize view param
    const viewParam = new URLSearchParams(location.search).get('view');
    if(viewParam==='table') setView('table');
  })();
</script>