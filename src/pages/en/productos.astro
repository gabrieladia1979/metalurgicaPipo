---
// src/pages/en/productos.astro
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import ProductCard from '../../components/ProductCard.astro';
import IndustrialPartCard from '../../components/IndustrialPartCard.astro';
import ProductTable from '../../components/ProductTable.astro';
import Footer from '../../components/Footer.astro';
import site from '../../data/site.json';

// Sample data - replace with CMS or database
const productos = [
  {
    id: 1,
    partNumber: '450-12',
    title: 'Concentric Valve Model 450',
    category: 'Valves',
    description: 'Valve for compressors, carbon steel body.',
    image: '',
    inStock: true,
    pdf: '/docs/valvula-450.pdf',
    specs: { 'Material': 'Steel', 'Diameter': '40 mm', 'Pressure': '200 Bar' }
  },
  {
    id: 2,
    partNumber: 'A-210',
    title: 'Adjustment Ring A-210',
    category: 'Rings',
    description: 'Retaining ring for rotating shafts.',
    image: '',
    inStock: false,
    pdf: '',
    specs: { 'Material': 'Cast Iron', 'Application': 'Shafts 210 mm' }
  },
  {
    id: 3,
    partNumber: 'EMP-03',
    title: 'Packing Type 03',
    category: 'Packings',
    description: 'Packing for sealing valves and pumps.',
    image: '',
    inStock: true,
    pdf: '/docs/empaquetadura-03.pdf',
    specs: { 'Material': 'Graphite', 'Temperature': '-50°C to 400°C' }
  },
];
---

<Layout title="Products">
  <Header />

  <main class="min-h-screen bg-white">
    {/* Header */}
    <div class="bg-gradient-to-b from-gray-50 to-white py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          Product Catalog
        </h1>
        <p class="text-lg text-gray-600">
          Explore our wide selection of professional gastronomic equipment
        </p>
      </div>
    </div>

    {/* Products Grid */}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:gap-4">
          <input id="page-search-input" type="search" placeholder="Filter by code, name or category" class="w-full md:w-1/2 border border-gray-300 rounded-lg py-2 px-3 text-sm" />
          <div class="mt-3 md:mt-0 flex gap-2">
            <button id="view-grid" type="button" class="px-3 py-2 bg-white border border-gray-300 rounded text-sm">Grid View</button>
            <button id="view-table" type="button" class="px-3 py-2 bg-white border border-gray-300 rounded text-sm">Table View</button>
          </div>
        </div>
        <p id="search-results" class="text-sm text-gray-600 mt-2"></p>
      </div>

      <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {productos.map((producto) => (
          <IndustrialPartCard
            partNumber={producto.partNumber}
            name={producto.title}
            specs={producto.specs}
            image={producto.image}
            inStock={producto.inStock}
            pdf={producto.pdf}
          />
        ))}
      </div>

      <div id="products-table" class="hidden mt-8">
        <ProductTable products={productos} />
      </div>
    </div>

    {/* CTA Final */}
    <section class="bg-bergner-red text-white py-16 mt-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Didn't find what you're looking for?</h2>
        <p class="text-lg mb-8 opacity-90">
          Contact us to inquire about other products or place a custom order.
        </p>
        <a 
          href={`https://wa.me/${site.whatsappNumber}?text=${encodeURIComponent('Hello, I have a question about Bergner products...')}`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-block bg-white text-bergner-red hover:bg-gray-100 px-8 py-4 rounded-lg font-bold transition-colors"
        >
          Contact via WhatsApp
        </a>
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  (function(){
    const params = new URLSearchParams(location.search);
    const q = (params.get('q')||'').toLowerCase().trim();
    const grid = document.getElementById('products-grid');
    const items = grid?.querySelectorAll('[data-title]');
    const headerInput = document.getElementById('header-search-input');
    const pageInput = document.getElementById('page-search-input');
    const resultsEl = document.getElementById('search-results');

    if(headerInput && q) headerInput.value = params.get('q');
    if(pageInput && q) pageInput.value = params.get('q');

    function filter(term){
      const t = (term||'').toLowerCase().trim();
      let any=false;
      items?.forEach(el=>{
        const title = (el.dataset.title||'').toLowerCase();
        const cat = (el.dataset.category||'').toLowerCase();
        const desc = (el.dataset.description||'').toLowerCase();
        const show = !t || title.includes(t) || cat.includes(t) || desc.includes(t);
        el.style.display = show ? '' : 'none';
        if(show) any = true;
      });
      if(resultsEl){
        resultsEl.textContent = t ? (any ? `Results for "${t}"` : `No results found for "${t}"`) : '';
      }
    }

    // initial
    filter(q);

    // listen for input on page
    if(pageInput){
      pageInput.addEventListener('input', (e)=>{
        const val = e.target.value;
        history.replaceState(null, '', val ? `?q=${encodeURIComponent(val)}` : location.pathname);
        if(headerInput) headerInput.value = val;
        filter(val);
      });
    }

    // View toggle (grid / table)
    const btnGrid = document.getElementById('view-grid');
    const btnTable = document.getElementById('view-table');
    const gridEl = document.getElementById('products-grid');
    const tableEl = document.getElementById('products-table');

    function setView(view){
      if(view==='table'){
        gridEl.classList.add('hidden');
        tableEl.classList.remove('hidden');
        history.replaceState(null,'',`?view=table${pageInput?.value?`&q=${encodeURIComponent(pageInput.value)}`:''}`);
      } else {
        tableEl.classList.add('hidden');
        gridEl.classList.remove('hidden');
        history.replaceState(null,'',`${location.pathname}${pageInput?.value?`?q=${encodeURIComponent(pageInput.value)}`:''}`);
      }
    }

    btnGrid?.addEventListener('click', ()=> setView('grid'));
    btnTable?.addEventListener('click', ()=> setView('table'));

    // initialize view param
    const viewParam = new URLSearchParams(location.search).get('view');
    if(viewParam==='table') setView('table');
  })();
</script>
